[![Build Status](https://travis-ci.org/vad4msiu/diff.png)](https://travis-ci.org/vad4msiu/diff)

### Задача

Есть два файла больших размеров, по несколько ГБ, содержащие неупорядоченный список путей ко всем файлам от корня в файловой системе в разные моменты времени.

Пример файла:
```
/home/user/file1.txt
/etc/hosts
/home/Vasya/video/hot_girls.avi
...
```
Задача - за приемлемое время и с приемлемым расходом памяти (предположим, что доступной памяти 512МБ) вывести списки новых и удаленных файлов.

### Варианты решения

1. Отсортировать файл, а дальше нахождение удаленных и добавленных файлов будет простым. Так как есть ограничение по RAM, то отсортировать в памени файлы целиком не удастся, по этому придется сортировать частями. Отсортированные части записывать на диск и мержить. Слишком много работы с диском.
2. Воспользоваться key value storage (например GDBM). Создаем файлы хранилища по которым будет легко искать. Пробегаясь по исходным файлам можно смотреть в хранилище и определять удален или добавлен путь. Создание большого хранилища ресурсоемко.
3. Так как файловая система это древовидная структура, а в файле много избыточной информации, можно попытаться воспользоваться к примеру хеш таблицами и уместить все в RAM. Для 2 ГБ не умещается. Ruby объекты очень прожорливые.
4. Хранить в памяти части файлов в виде структуры данных множество (Set). Ограничение по RAM реализовать через ограничение количества хранимых в RAM строк.

### Алгоритм

Наиболее удачным оказался 4 вариант решения. Основные шаги алгоритма такие:

1. читаем часть первого файла
2. читаем часть второго файла
3. представляем прочтенные части в виде множеств
4. находим пересечение множеств из прочтенных частей
5. удаляем из первого множества найденное пересечение
6. повторяем шаги 2 - 4 до тех пор пока второй файл не будет полностью прочитан
7. сохраняем оставшиеся первое множество
8. повторяем шаги 1 - 7 до тех пор пока первый файл не будет полностью прочитан
9. объединение множеств сохраненных на шаге 7 будет является списком удаленных файлов
10. повторив шаги 1 - 9 только изменив порядок файлов получим списком новых файлов

### Использование
```
git clone https://github.com/vad4msiu/diff.git
cd diff
bundle install
./bin/diff path_to_file_1 path_to_file_2 --waterline 5_000_000
```
